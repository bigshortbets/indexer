name: ci

on:
  push:

jobs:
  install-node:
    name: Install NodeJS
    runs-on: ubuntu-latest

    steps:
      - name: Setup NodeJS
        uses: actions/setup-node@v2
        with:
          node-version: '20'

  build:
    name: Build the project
    needs: install-node
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4

      - name: Install typescript
        run: npm install -g typescript

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

  check-blockchain-metadata:
    name: Check if metadata are in sync with blockchain
    needs: install-node
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4

      - name: Install substrate metadata explorer
        run: npm install -g @subsquid/substrate-metadata-explorer

      - name: Check metadata
        env:
          BLOCKCHAIN_NODE_RPC: ${{ secrets.BLOCKCHAIN_NODE_RPC }}
        run: squid-substrate-metadata-explorer --rpc $BLOCKCHAIN_NODE_RPC --out types.jsonl

      - name: Check if metadata requires update
        run: git diff --exit-code types.jsonl

  check-typeorm-entities:
    name: Check if TypeORM entities are generated from the schema file
    needs: install-node
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4

      - name: Install sqd toolset
        run: npm install -g @subsquid/cli@latest

      - name: Install typeorm-codegen
        run: npm install @subsquid/typeorm-codegen --save-dev

      - name: Execute typegen
        run: sqd typegen

      - name: Check if sqd typegen needs to be executed locally
        run: git diff --exit-code src/types

  check-data-access-classes:
    name: Check if data access classes are generated for an substrate metadata
    needs: install-node
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4

      - name: Install sqd toolset
        run: npm install -g @subsquid/cli@latest

      - name: Install typeorm-codegen
        run: npm install @subsquid/typeorm-codegen --save-dev

      - name: Execute codegen
        run: sqd codegen

      - name: Check if sqd codegen needs to be executed locally
        run: git diff --exit-code src/model/generated
